<!DOCTYPE html>
<html>
<head>
    <title>CREW CONTROL</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 500;
            background: #0a0b1e;
            color: #e1e8ed;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(56, 189, 248, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(59, 130, 246, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(99, 102, 241, 0.08) 0%, transparent 60%);
            animation: backgroundShift 20s ease-in-out infinite;
            z-index: -1;
        }
        
        @keyframes backgroundShift {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(5deg); }
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Main content area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 60px;
        }
        
        .title {
            font-size: 4rem;
            font-weight: 900;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 50%, #6366f1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            text-shadow: 0 0 40px rgba(59, 130, 246, 0.5);
        }
        
        .subtitle {
            color: #64748b;
            font-size: 1.1rem;
            font-weight: 500;
            letter-spacing: 0.05em;
        }
        
        /* Hub cards */
        .hub-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            width: 100%;
            max-width: 900px;
        }
        
        .hub-card {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .hub-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), rgba(59, 130, 246, 0.15) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .hub-card:hover::before {
            opacity: 1;
        }
        
        .hub-card:hover {
            transform: translateY(-4px);
            border-color: rgba(59, 130, 246, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .hub-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 8px;
        }
        
        .hub-info {
            font-size: 0.9rem;
            color: #94a3b8;
            font-weight: 500;
        }
        
        /* Scripts view */
        .scripts-container {
            display: none;
            width: 100%;
            max-width: 1200px;
        }
        
        .back-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding: 0 20px;
        }
        
        .back-btn, .settings-btn {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.2);
            color: #e2e8f0;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .back-btn:hover, .settings-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        }
        
        #hubTitle {
            font-size: 1.8rem;
            font-weight: 700;
            color: #f1f5f9;
            text-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        
        .script-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 32px;
            padding: 20px;
        }
        
        .script-btn {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 3px solid;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            color: #ffffff;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            text-align: center;
            padding: 20px;
        }
        
        .script-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, currentColor 0%, transparent 70%);
            opacity: 0.1;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
        }
        
        .script-btn:hover {
            transform: scale(1.08);
        }
        
        .script-btn:hover::before {
            opacity: 0.2;
            width: 120%;
            height: 120%;
        }
        
        .script-btn:active {
            transform: scale(0.95);
        }
        
        .execute-text {
            font-size: 1.1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .script-name {
            font-size: 0.75rem;
            font-weight: 600;
            opacity: 0.9;
            text-align: center;
            max-width: 140px;
            line-height: 1.2;
        }
        
        /* Sidebar */
        .sidebar {
            width: 320px;
            background: rgba(15, 23, 42, 0.8);
            border-left: 1px solid rgba(148, 163, 184, 0.1);
            padding: 32px 24px;
            display: flex;
            flex-direction: column;
            gap: 32px;
            backdrop-filter: blur(20px);
        }
        
        .sidebar-section {
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            padding: 20px;
        }
        
        .sidebar-section h4 {
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #94a3b8;
            margin-bottom: 16px;
        }
        
        .users-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .user-item {
            padding: 6px 14px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 20px;
            color: #e2e8f0;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .activity-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .activity-item {
            padding: 8px 12px;
            background: rgba(30, 41, 59, 0.3);
            border-radius: 8px;
            border-left: 3px solid;
            font-size: 0.8rem;
            font-weight: 500;
            color: #cbd5e1;
        }
        
        .activity-item.success {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .activity-item.error {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        /* Timer */
        .timer-section {
            text-align: center;
        }
        
        .stop-timer-btn {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s ease;
            margin-top: 12px;
        }
        
        .stop-timer-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: translateY(-1px);
        }
        
        .timer-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: #3b82f6;
            font-variant-numeric: tabular-nums;
        }
        
        .timer-label {
            font-size: 0.8rem;
            color: #94a3b8;
            font-weight: 600;
            margin-top: 8px;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: #1e293b;
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }
        
        .modal h3 {
            color: #f1f5f9;
            margin-bottom: 24px;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .setting {
            margin-bottom: 24px;
        }
        
        .setting label {
            color: #cbd5e1;
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
        }
        
        .radio-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
        }
        
        .radio-group input {
            margin-right: 8px;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 32px;
        }
        
        .modal-btn {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60a5fa;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .modal-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }
        
        /* Result display */
        .result-display {
            margin: 20px;
            padding: 16px;
            border-radius: 12px;
            font-weight: 500;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
        
        .result-success {
            border-color: rgba(16, 185, 129, 0.5);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .result-error {
            border-color: rgba(239, 68, 68, 0.5);
            background: rgba(239, 68, 68, 0.1);
        }
        
        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1e293b;
            border: 1px solid rgba(148, 163, 184, 0.2);
            color: #e2e8f0;
            padding: 14px 20px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            font-weight: 500;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast.fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }
        
        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(100%); }
        }
        
        /* Loading state */
        .loading {
            text-align: center;
            color: #64748b;
            font-style: italic;
            padding: 40px;
            font-weight: 500;
        }
        
        /* Refresh button */
        .hub-list-header {
            display: flex;
            justify-content: center;
            margin-bottom: 24px;
        }
        
        .refresh-btn {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.3);
            color: #e2e8f0;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .refresh-btn:hover {
            background: rgba(30, 41, 59, 1);
            border-color: rgba(148, 163, 184, 0.5);
            transform: translateY(-1px);
        }
        
        .refresh-btn:active {
            transform: translateY(0);
        }
        
        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .refresh-btn.loading #refreshIcon {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Hide sidebar on small screens */
        @media (max-width: 1024px) {
            .sidebar {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="header">
                <h1 class="title">SP CREW CONTROL</h1>
                <p class="subtitle">Remote Command Interface</p>
            </div>
            
            <!-- Hub List -->
            <div id="hubListContainer">
                <div class="hub-list-header">
                    <button class="refresh-btn" id="refreshBtn" onclick="refreshHubs()" title="Refresh hub list">
                        <span id="refreshIcon">üîÑ</span> <span id="refreshText">REFRESH</span>
                    </button>
                </div>
                <div id="hubList" class="hub-grid"></div>
            </div>
            
            <!-- Scripts Interface -->
            <div id="scriptsContainer" class="scripts-container">
                <div class="back-header">
                    <button class="back-btn" onclick="backToHubs()">‚Üê BACK</button>
                    <h2 id="hubTitle"></h2>
                    <button class="settings-btn" onclick="showSettings()">‚öô SETTINGS</button>
                </div>
                <div id="scriptGrid" class="script-grid"></div>
                <div id="executionResult" class="result-display" style="display: none;"></div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar" style="display: none;">
            <div class="sidebar-section">
                <h4>Connected Users</h4>
                <div id="connectedUsers" class="users-list"></div>
            </div>
            
            <div class="sidebar-section">
                <h4>Activity Feed</h4>
                <div id="activityItems" class="activity-items"></div>
            </div>
            
            <div class="sidebar-section timer-section" id="timerSection" style="display: none;">
                <div id="timerDisplayValue" class="timer-value">00:00</div>
                <div class="timer-label">TIME UNTIL NEXT SHUFFLE</div>
                <button class="stop-timer-btn" onclick="stopTimer()">STOP TIMER</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h3>HUB CONFIGURATION</h3>
            <div class="setting">
                <label>MODE:</label>
                <div class="radio-group">
                    <label><input type="radio" name="mode" value="assigned"> 1 BUTTON</label>
                    <label><input type="radio" name="mode" value="shared"> ALL BUTTONS</label>
                </div>
            </div>
            <div class="setting" id="showNamesetting">
                <label><input type="checkbox" id="showNames"> Show Script Names</label>
            </div>
            <div class="setting" id="timerSetting">
                <label>TIMER (MINUTES):</label>
                <input type="number" id="timerMinutes" min="1" max="60" value="5" style="background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(148, 163, 184, 0.2); color: #e2e8f0; padding: 8px; border-radius: 6px; width: 80px; font-weight: 500;">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn" onclick="closeSettings()">CLOSE</button>
                <button class="modal-btn" onclick="saveSettings()">SAVE</button>
                <button class="modal-btn" id="shuffleBtn" onclick="shuffleScripts()">SHUFFLE BUTTONS</button>
            </div>
        </div>
    </div>
    
    <script>
        let connectedHub = null;
        let hubScripts = [];
        let myAssignment = null;
        let timerInterval = null;
        let timerSeconds = 0;
        let connectedUsers = [];
        let activityLog = [];
        const userId = 'user-' + Math.random().toString(36).substr(2, 9);
        
        // Discover hubs on load
        discoverHubs();
        
        async function refreshHubs() {
            const refreshBtn = document.getElementById('refreshBtn');
            const refreshIcon = document.getElementById('refreshIcon');
            const refreshText = document.getElementById('refreshText');
            
            // Set loading state
            refreshBtn.disabled = true;
            refreshBtn.classList.add('loading');
            refreshText.textContent = 'SEARCHING...';
            
            try {
                await discoverHubs();
                showToast('Hub list refreshed');
            } catch (error) {
                showToast('Failed to refresh hub list');
                console.error('Refresh error:', error);
            } finally {
                // Reset button state
                refreshBtn.disabled = false;
                refreshBtn.classList.remove('loading');
                refreshText.textContent = 'REFRESH';
            }
        }
        
        async function discoverHubs() {
            const hubList = document.getElementById('hubList');
            
            // Show loading state in hub list
            if (hubList.children.length === 0) {
                hubList.innerHTML = '<div class="loading">Searching for hubs...</div>';
            }
            
            const response = await fetch('/api/hubs');
            const data = await response.json();
            
            hubList.innerHTML = '';
            
            if (!data.hubs || data.hubs.length === 0) {
                hubList.innerHTML = '<div class="loading">No active hubs found</div>';
                return;
            }
                
                data.hubs.forEach(hub => {
                    const hubCard = document.createElement('div');
                    hubCard.className = 'hub-card';
                    hubCard.innerHTML = `
                        <div class="hub-name">${hub.friendly_name}</div>
                        <div class="hub-info">${hub.script_count} scripts ‚Ä¢ ${hub.mode} mode</div>
                    `;
                    
                    // Add mouse tracking for gradient effect
                    hubCard.addEventListener('mousemove', (e) => {
                        const rect = hubCard.getBoundingClientRect();
                        const x = ((e.clientX - rect.left) / rect.width) * 100;
                        const y = ((e.clientY - rect.top) / rect.height) * 100;
                        hubCard.style.setProperty('--mouse-x', `${x}%`);
                        hubCard.style.setProperty('--mouse-y', `${y}%`);
                    });
                    
                    hubCard.onclick = () => connectToHub(hub);
                    hubList.appendChild(hubCard);
                });
            } catch (error) {
                console.error('Hub discovery error:', error);
            }
        }
        
        async function connectToHub(hub) {
            connectedHub = hub;
            myAssignment = null;
            
            document.getElementById('hubListContainer').style.display = 'none';
            document.getElementById('scriptsContainer').style.display = 'block';
            document.getElementById('sidebar').style.display = 'flex';
            document.getElementById('hubTitle').textContent = hub.friendly_name.toUpperCase();
            
            if (hub.mode === 'assigned') {
                await requestAssignment(hub.id);
            } else {
                await loadHubScripts(hub.id);
            }
            
            showScripts();
            updateShuffleButton();
            updateConnectedUsers();
            showToast(`Connected to ${hub.friendly_name}`);
        }
        
        async function requestAssignment(hubId) {
            try {
                await fetch('/api/remote-assignment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hub_id: hubId, user_id: userId })
                });
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const response = await fetch(`/api/remote-assignment?hub_id=${hubId}&user_id=${userId}`);
                const data = await response.json();
                
                if (data.success && data.assignment) {
                    myAssignment = data.assignment;
                }
            } catch (error) {
                console.error('Assignment request error:', error);
            }
        }
        
        async function loadHubScripts(hubId) {
            try {
                const response = await fetch(`/api/hub-scripts?hub_id=${hubId}`);
                const data = await response.json();
                
                if (data.success) {
                    hubScripts = data.scripts;
                }
            } catch (error) {
                console.error('Load scripts error:', error);
                hubScripts = [];
            }
        }
        
        function showScripts() {
            const grid = document.getElementById('scriptGrid');
            grid.innerHTML = '';
            
            if (connectedHub.mode === 'assigned') {
                if (myAssignment && myAssignment.assigned_script) {
                    const button = createScriptButton(myAssignment.assigned_script, myAssignment.script_color || '#3b82f6');
                    grid.appendChild(button);
                } else {
                    grid.innerHTML = '<div class="loading">Waiting for assignment...</div>';
                }
            } else {
                if (hubScripts.length === 0) {
                    grid.innerHTML = '<div class="loading">No scripts available</div>';
                    return;
                }
                
                hubScripts.forEach((scriptName, index) => {
                    const hue = (index * 137.5) % 360;
                    const color = `hsl(${hue}, 70%, 50%)`;
                    const button = createScriptButton(scriptName, color);
                    grid.appendChild(button);
                });
            }
        }
        
        function createScriptButton(scriptName, color) {
            const button = document.createElement('button');
            button.className = 'script-btn';
            button.style.borderColor = color;
            button.style.color = color;
            button.style.boxShadow = `0 0 20px ${color}33`;
            
            const executeText = document.createElement('div');
            executeText.className = 'execute-text';
            executeText.textContent = 'EXECUTE';
            button.appendChild(executeText);
            
            if (connectedHub.show_script_names) {
                const scriptNameEl = document.createElement('div');
                scriptNameEl.className = 'script-name';
                scriptNameEl.textContent = scriptName.toUpperCase();
                button.appendChild(scriptNameEl);
            }
            
            button.onmouseover = () => {
                button.style.boxShadow = `0 0 40px ${color}66`;
            };
            button.onmouseout = () => {
                button.style.boxShadow = `0 0 20px ${color}33`;
            };
            
            button.onclick = () => executeScript(scriptName);
            
            return button;
        }
        
        async function executeScript(scriptName) {
            const resultDiv = document.getElementById('executionResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-display';
            resultDiv.innerHTML = `<strong>EXECUTING ${scriptName.toUpperCase()}...</strong>`;
            
            console.log('Executing script:', scriptName, 'Hub ID:', connectedHub.id, 'User ID:', userId);
            
            try {
                const response = await fetch('/api/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        hub_id: connectedHub.id,
                        script_name: scriptName,
                        user_id: userId
                    })
                });
                
                const result = await response.json();
                console.log('Execution result:', result);
                
                if (result.success) {
                    resultDiv.className = 'result-display result-success';
                    resultDiv.innerHTML = `<strong>SUCCESS</strong><br>Script: ${scriptName}<br>Output: ${result.output || 'Complete'}`;
                    addToActivityLog(`Executed: ${scriptName}`, 'success');
                    showToast(`‚úÖ ${scriptName} executed successfully`);
                } else {
                    resultDiv.className = 'result-display result-error';
                    resultDiv.innerHTML = `<strong>ERROR</strong><br>Script: ${scriptName}<br>Error: ${result.error || 'Unknown error'}`;
                    addToActivityLog(`Failed: ${scriptName}`, 'error');
                    showToast(`‚ùå ${scriptName} execution failed: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Execution error:', error);
                resultDiv.className = 'result-display result-error';
                resultDiv.innerHTML = `<strong>CONNECTION ERROR</strong><br>${error.message}`;
                addToActivityLog(`Connection error: ${scriptName}`, 'error');
            }
        }
        
        function backToHubs() {
            connectedHub = null;
            document.getElementById('hubList').style.display = 'grid';
            document.getElementById('scriptsContainer').style.display = 'none';
            document.getElementById('sidebar').style.display = 'none';
            discoverHubs();
        }
        
        function showSettings() {
            if (!connectedHub) return;
            
            const modal = document.getElementById('settingsModal');
            const modeRadios = modal.querySelectorAll('input[name="mode"]');
            const showNamesCheck = modal.querySelector('#showNames');
            
            modeRadios.forEach(radio => {
                radio.checked = radio.value === connectedHub.mode;
                // Add event listener to update display when mode changes
                radio.addEventListener('change', updateSettingsDisplay);
            });
            showNamesCheck.checked = connectedHub.show_script_names || false;
            
            // Update conditional display based on current mode
            updateSettingsDisplay();
            
            modal.style.display = 'flex';
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }
        
        
        function shuffleScripts() {
            if (connectedHub.mode !== 'assigned') return;
            
            // Only works in 1 Button mode - reassign scripts
            if (myAssignment) {
                requestAssignment(connectedHub.id);
                showToast('Button shuffled');
            }
        }
        
        function updateShuffleButton() {
            const shuffleBtn = document.getElementById('shuffleBtn');
            if (shuffleBtn) {
                shuffleBtn.disabled = connectedHub && connectedHub.mode !== 'assigned';
                shuffleBtn.style.opacity = shuffleBtn.disabled ? '0.5' : '1';
            }
        }
        
        function startTimer() {
            const minutes = parseInt(document.getElementById('timerMinutes').value) || 5;
            timerSeconds = minutes * 60;
            
            if (timerInterval) clearInterval(timerInterval);
            
            // Show timer section
            document.getElementById('timerSection').style.display = 'block';
            
            timerInterval = setInterval(() => {
                timerSeconds--;
                updateTimerDisplay();
                
                if (timerSeconds <= 0) {
                    shuffleScripts();
                    timerSeconds = minutes * 60;
                    showToast('Timer completed - Scripts shuffled!');
                }
            }, 1000);
            
            updateTimerDisplay();
            showToast(`Timer started: ${minutes} minutes until shuffle`);
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('timerDisplayValue').textContent = timeString;
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                document.getElementById('timerSection').style.display = 'none';
                showToast('Timer stopped');
            }
        }
        
        function updateSettingsDisplay() {
            const modeRadios = document.querySelectorAll('input[name="mode"]');
            const selectedMode = [...modeRadios].find(r => r.checked)?.value || connectedHub?.mode || 'assigned';
            
            const showNamesSetting = document.getElementById('showNamesetting');
            const timerSetting = document.getElementById('timerSetting');
            const shuffleBtn = document.getElementById('shuffleBtn');
            
            if (selectedMode === 'shared') {
                // All Buttons mode - hide show names and timer
                showNamesSetting.style.display = 'none';
                timerSetting.style.display = 'none';
                shuffleBtn.style.display = 'none';
            } else {
                // 1 Button mode - show all options
                showNamesSetting.style.display = 'block';
                timerSetting.style.display = 'block';
                shuffleBtn.style.display = 'inline-block';
            }
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
        
        function addToActivityLog(message, type = 'info') {
            const activityItems = document.getElementById('activityItems');
            
            const timestamp = new Date().toLocaleTimeString();
            const item = document.createElement('div');
            item.className = `activity-item ${type}`;
            item.textContent = `${timestamp} - ${message}`;
            
            activityItems.insertBefore(item, activityItems.firstChild);
            
            // Keep only last 10 items
            while (activityItems.children.length > 10) {
                activityItems.removeChild(activityItems.lastChild);
            }
        }
        
        async function updateConnectedUsers() {
            if (!connectedHub) return;
            
            try {
                const response = await fetch(`/api/connected-users?hub_id=${connectedHub.id}`);
                const data = await response.json();
                
                if (data.success && data.users && data.users.length > 0) {
                    connectedUsers = data.users;
                } else {
                    // Only show current user if no others connected
                    connectedUsers = [username || `User-${userId.split('-')[1].toUpperCase()}`];
                }
            } catch (error) {
                console.error('Error fetching connected users:', error);
                // Only show current user on error
                connectedUsers = [username || `User-${userId.split('-')[1].toUpperCase()}`];
            }
            
            const usersContainer = document.getElementById('connectedUsers');
            usersContainer.innerHTML = connectedUsers.map(user => 
                `<div class="user-item">${user}</div>`
            ).join('');
        }
        
        // Add timer controls to save settings
        function saveSettings() {
            const modeRadios = document.querySelectorAll('input[name="mode"]');
            const showNamesCheck = document.querySelector('#showNames');
            const timerMinutes = document.getElementById('timerMinutes').value;
            
            const selectedMode = [...modeRadios].find(r => r.checked)?.value;
            const showNames = showNamesCheck.checked;
            
            if (selectedMode) {
                connectedHub.mode = selectedMode;
                connectedHub.show_script_names = showNames;
                
                // Refresh display
                showScripts();
                updateShuffleButton();
                
                // Start timer only in 1 Button mode if value is set
                if (selectedMode === 'assigned' && timerMinutes && parseInt(timerMinutes) > 0) {
                    startTimer();
                }
                
                // TODO: Save to database
                showToast(`Settings updated: ${selectedMode === 'assigned' ? '1 Button' : 'All Buttons'} mode`);
            }
            
            closeSettings();
        }
        
        function backToHubs() {
            connectedHub = null;
            myAssignment = null;
            
            document.getElementById('hubListContainer').style.display = 'block';
            document.getElementById('scriptsContainer').style.display = 'none';
            document.getElementById('sidebar').style.display = 'none';
            
            // Refresh hub list when going back
            discoverHubs();
        }
        
        // Auto-refresh (silent)
        setInterval(() => {
            if (!connectedHub) {
                discoverHubs(); // Silent refresh
            } else {
                updateConnectedUsers();
            }
        }, 30000);
    </script>
</body>
</html>